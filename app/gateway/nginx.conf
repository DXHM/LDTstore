# NGINX App Gateway Config for ldtstore.com.cn Rev 0.5.1
# Copyright 2021 stackinspector. MIT Lincese.

user nginx;
pcre_jit on;
events {}

error_log logs/error debug;

http {

    # generated from the following argument list string and JavaScript code
    # 'time_iso8601  remote_addr remote_user  request http_referer http_user_agent http_accept http_x_forwarded_for http_cookie
    #   status bytes_sent body_bytes_sent  connection connection_requests'
    # `log_format json_detailed escape=json '{` + args.replace(/  /g, ' ').split(' ').map(arg => `"${arg}":"$${arg}"`).join(`,`) + `}';`
    log_format json_detailed escape=json '{"time_iso8601":"$time_iso8601","remote_addr":"$remote_addr","remote_user":"$remote_user","request":"$request","http_referer":"$http_referer","http_user_agent":"$http_user_agent","http_accept":"$http_accept","http_x_forwarded_for":"$http_x_forwarded_for","http_cookie":"$http_cookie","status":"$status","bytes_sent":"$bytes_sent","body_bytes_sent":"$body_bytes_sent","connection":"$connection","connection_requests":"$connection_requests"}';
    access_log logs/access json_detailed;

    # performance optimizations
    sendfile   on;
    tcp_nopush on;
    gzip       on;
    gzip_types application/json;

    # traffic limit
    limit_req_zone $binary_remote_addr zone=global:128m rate=10r/s;
    limit_req_status 444;

    server {

        listen      443 ssl http2;
        listen      [::]:443 ssl http2;
        server_name ldtstore.com.cn;

        # ssl certificate files
        ssl_certificate     /app/cert/ldtstore.com.cn_bundle.pem;
        ssl_certificate_key /app/cert/ldtstore.com.cn.key;

        # ssl configurations
        ssl_protocols       TLSv1.3;
        # cipher config generated by: https://ssl-config.mozilla.org/#server=nginx&version=1.20.2&config=modern&openssl=1.1.1k&guideline=5.6
        ssl_prefer_server_ciphers off;
        ssl_session_cache   shared:SSL:10m;
        # currently there is no need to configure DNS CAA and OSCP Stapling

        # hsts support
        add_header Strict-Transport-Security "max-age=31536000; preload" always;
        # traffic limit
        limit_req zone=global burst=10;

        # files
        root /app/wwwroot;

        # content type
        charset utf-8;
        include /etc/nginx/mime.types;

        # redirecting server
        location /r/ {
            proxy_buffering  off;
            proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
            proxy_pass       http://127.0.0.1:10305/;
        }
        location /r2/ {
            proxy_buffering  off;
            proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
            proxy_pass       http://127.0.0.1:20610/;
        }

    }

}
